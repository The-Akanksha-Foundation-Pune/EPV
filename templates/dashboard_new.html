{% extends 'base_salesforce.html' %}

{% block title %}Dashboard - Expense Management Portal{% endblock %}

{% block additional_styles %}
.feature-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: var(--sf-blue);
}
.dashboard-card {
    height: 100%;
}
.stat-card {
    transition: transform 0.2s;
}
.stat-card:hover {
    transform: translateY(-5px);
}
{% endblock %}

{% block content %}

<!-- Main Content -->
<main class="container mt-4">
    <!-- Welcome Alert -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="welcomeAlert" class="alert alert-success d-flex align-items-center">
                <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>Welcome, {{ session.get('user_info').name }}!</strong>
                    You're logged in to the Expense Management Portal.
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Auto-hide welcome message script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the welcome alert element
            const welcomeAlert = document.getElementById('welcomeAlert');

            // Set a timeout to hide the alert after 5 seconds
            if (welcomeAlert) {
                setTimeout(function() {
                    // Create a bootstrap alert instance and close it
                    const bsAlert = new bootstrap.Alert(welcomeAlert);
                    bsAlert.close();
                }, 5000); // 5000 milliseconds = 5 seconds
            }
        });
    </script>

    <!-- Stats Cards -->
    <div class="dashboard-stats mb-4">
        <div class="stat-card">
            <div class="stat-value text-primary">3</div>
            <div class="stat-label">Pending Claims</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-success">12</div>
            <div class="stat-label">Approved This Month</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-info">â‚¹24,500</div>
            <div class="stat-label">Total Amount</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-warning">2.3 days</div>
            <div class="stat-label">Avg. Processing Time</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <h4 class="mb-3">Quick Actions</h4>
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card dashboard-card expense-card">
                <div class="card-body text-center">
                    <div class="feature-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <h5 class="card-title">New Expense</h5>
                    <p class="card-text">Create a new expense voucher for reimbursement.</p>
                    <a href="{{ url_for('new_expense') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Create
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card dashboard-card expense-card">
                <div class="card-body text-center">
                    <div class="feature-icon">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <h5 class="card-title">My Expenses</h5>
                    <p class="card-text">View and manage all your expense records.</p>
                    <a href="{{ url_for('epv_records') }}" class="btn btn-primary">
                        <i class="fas fa-eye me-1"></i> View Records
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card dashboard-card expense-card">
                <div class="card-body text-center">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5 class="card-title">Reports</h5>
                    <p class="card-text">Generate and view expense reports and analytics.</p>
                    <a href="#" class="btn btn-primary">
                        <i class="fas fa-chart-bar me-1"></i> View Reports
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Information -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">User Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3 text-primary">Google Account</h6>
                            <p><strong>Name:</strong> {{ session.get('user_info').name }}</p>
                            <p><strong>Email:</strong> {{ session.get('user_info').email }}</p>
                            <p><strong>Google ID:</strong> {{ session.get('user_info').id }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3 text-primary">Employee Details</h6>
                            {% if session.get('employee_role') or session.get('employee_manager') or session.get('employee_id') %}
                                <p><strong>Employee ID:</strong> {{ session.get('employee_id') or 'Not set' }}</p>
                                <p><strong>Role:</strong> {{ session.get('employee_role') or 'Not set' }}</p>
                                <p><strong>Manager:</strong> {{ session.get('employee_manager') or 'Not set' }}</p>
                                {% if session.get('employee_role') == 'admin' %}
                                <p>
                                    <a href="{{ url_for('employees') }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-users me-1"></i> View All Employees
                                    </a>
                                </p>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i> Your email is not registered in the employee database.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- JavaScript Dependencies -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- Login timing measurement script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we have a login start time in localStorage
        const loginStartTime = localStorage.getItem('loginStartTime');
        if (loginStartTime) {
            // Calculate how long the login process took
            const endTime = new Date().getTime();
            const loadTime = (endTime - parseInt(loginStartTime)) / 1000; // Convert to seconds

            console.log('Login process took ' + loadTime.toFixed(2) + ' seconds');

            // Update the LoadingScreen object with the measured time
            if (window.LoadingScreen && typeof LoadingScreen.loadTimes === 'object') {
                // Update the login time with a weighted average (80% new, 20% old)
                const oldTime = LoadingScreen.loadTimes.login || 3;
                const newTime = oldTime * 0.2 + loadTime * 0.8;

                // Cap between 1-10 seconds
                LoadingScreen.loadTimes.login = Math.max(1, Math.min(10, newTime));

                console.log('Updated login load time to ' + LoadingScreen.loadTimes.login.toFixed(2) + ' seconds');
            }

            // Clear the start time
            localStorage.removeItem('loginStartTime');
        }
    });
</script>
{% endblock %}
