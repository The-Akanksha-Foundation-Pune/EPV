{% extends "base_salesforce.html" %}

{% block title %}New Expense - Expense Portal{% endblock %}

{% block additional_styles %}
    .email-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        background-color: var(--sf-blue);
        color: white;
        border-radius: 50px;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .card-header {
        background-color: var(--sf-blue);
        color: white;
        font-weight: 500;
        padding: 15px 20px;
    }

    .card-body {
        padding: 25px;
    }

    .form-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--sf-neutral-medium);
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .form-label {
        font-weight: 500;
        margin-bottom: 8px;
    }

    .required-field::after {
        content: '*';
        color: var(--sf-error);
        margin-left: 4px;
    }

    .input-group-text {
        background-color: var(--sf-neutral-light);
        border-right: none;
    }

    .input-group .form-control {
        border-left: none;
    }

    .input-group .form-control:focus {
        box-shadow: none;
        border-color: var(--sf-neutral-medium);
    }

    .input-group .form-control:focus + .input-group-text {
        border-color: var(--sf-neutral-medium);
    }

    .expense-item {
        background-color: var(--sf-neutral-light);
        border-radius: var(--sf-border-radius);
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
    }

    .remove-expense {
        position: absolute;
        top: 10px;
        right: 10px;
        color: var(--sf-error);
        cursor: pointer;
        font-size: 1.2rem;
    }

    .remove-expense:hover {
        color: #bd2130;
    }

    .alert {
        border-radius: var(--sf-border-radius);
        padding: 12px 15px;
    }

    .alert-info {
        background-color: var(--sf-blue-light);
        border-color: var(--sf-blue);
        color: var(--sf-blue);
    }

    .alert-info .alert-link {
        color: var(--sf-blue);
    }

    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 9999;
    }

    .ui-menu-item {
        padding: 8px 12px;
        cursor: pointer;
    }

    .ui-menu-item:hover {
        background-color: var(--sf-neutral-light);
    }

    .ui-helper-hidden-accessible {
        display: none;
    }

    .total-section {
        background-color: var(--sf-neutral-light);
        border-radius: var(--sf-border-radius);
        padding: 15px 20px;
        margin-top: 20px;
    }

    .total-amount {
        font-size: 1.2rem;
        font-weight: 500;
    }

    .amount-words {
        font-style: italic;
        color: var(--sf-text-light);
    }

    @media (max-width: 768px) {
        .card-body {
            padding: 15px;
        }
        .expense-item {
            padding: 15px;
        }
    }
{% endblock %}

{% block content %}
<div class="container mt-4 pt-3">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="fas fa-file-invoice-dollar me-2"></i> New Expense Claim</h5>
                </div>
                <div class="card-body">
                    <form id="expenseForm" method="POST" action="{{ url_for('new_expense') }}" enctype="multipart/form-data">
                        <!-- Employee Information Section -->
                        <div class="form-section">
                            <h5 class="mb-3"><i class="fas fa-user me-2"></i> Employee Information</h5>
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label for="employeeName" class="form-label required-field">Employee Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" class="form-control" id="employeeName" name="employee_name" placeholder="Type to search..." value="{{ session.get('user_info', {}).get('name', '') }}" required>
                                    </div>
                                    <div id="employeeNameHelp" class="form-text">Start typing to search for employees</div>
                                    <input type="hidden" id="employeeId" name="employee_id" value="{{ session.get('employee_id', '') }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="employeeIdDisplay" class="form-label required-field">Employee ID</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                        <input type="text" class="form-control" id="employeeIdDisplay" value="{{ session.get('employee_id', '') }}" placeholder="Auto-filled when employee is selected" disabled>
                                    </div>
                                    <div class="form-text">This field is automatically filled</div>
                                </div>
                            </div>
                            <input type="hidden" id="employeeEmail" name="email_id" value="{{ session.get('email', '') }}">
                            <input type="hidden" id="employeeManager" name="manager" value="{{ session.get('employee_manager', '') }}">
                        </div>

                        <!-- Expense Details Section -->
                        <div class="form-section">
                            <h5 class="mb-3"><i class="fas fa-file-invoice me-2"></i> Expense Details</h5>
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label for="costCenter" class="form-label required-field">Cost Center</label>
                                    <select class="form-select" id="costCenter" name="cost_center" required>
                                        <option value="">Select Cost Center</option>
                                        {% for center in cost_centers %}
                                        <option value="{{ center.id }}">{{ center.costcenter }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="paymentTo" class="form-label required-field">Payment To</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-money-bill"></i></span>
                                        <input type="text" class="form-control" id="paymentTo" name="expense_type" placeholder="Enter payment recipient" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label for="fromDate" class="form-label required-field">From Date</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        <input type="text" class="form-control datepicker" id="fromDate" name="from_date" placeholder="Select start date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="toDate" class="form-label required-field">To Date</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        <input type="text" class="form-control datepicker" id="toDate" name="to_date" placeholder="Select end date" required>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="academicYear" name="academic_year" value="2024-25">
                        </div>

                        <!-- Expense Items Section -->
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i> Expense Items</h5>
                                <button type="button" class="btn btn-sm btn-primary" id="addExpenseBtn">
                                    <i class="fas fa-plus"></i> Add Expense
                                </button>
                            </div>

                            <div id="expenseItems">
                                <!-- Expense item template will be added here dynamically -->
                                <div class="expense-item" id="expense-1">
                                    <i class="fas fa-times remove-expense" data-expense-id="1"></i>
                                    <div class="row mb-3">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <label for="invoiceDate-1" class="form-label required-field">Invoice Date</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                                <input type="text" class="form-control datepicker" id="invoiceDate-1" name="invoice_date[]" placeholder="Select date" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="expenseHead-1" class="form-label required-field">Expense Head</label>
                                            <select class="form-select" id="expenseHead-1" name="expense_head[]" required>
                                                <option value="">Select Expense Head</option>
                                                {% for head in expense_heads %}
                                                <option value="{{ head.head_name }}">{{ head.head_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <label for="amount-1" class="form-label required-field">Amount (₹)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">₹</span>
                                                <input type="number" class="form-control amount-input" id="amount-1" name="amount[]" placeholder="Enter amount" min="0" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <label for="description-1" class="form-label required-field">Description</label>
                                            <textarea class="form-control" id="description-1" name="description[]" rows="2" placeholder="Enter description" required></textarea>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <label for="receipt-1" class="form-label required-field">Upload Receipt</label>
                                            <div class="input-group">
                                                <input type="file" class="form-control" id="receipt-1" name="receipt[]" accept=".pdf,.jpg,.jpeg,.png" required>
                                                <label class="input-group-text" for="receipt-1"><i class="fas fa-upload"></i></label>
                                            </div>
                                            <div class="form-text">Accepted formats: PDF, JPG, JPEG, PNG (Max size: 5MB)</div>
                                        </div>
                                    </div>
                                    <div class="row mt-3 split-invoice-row" style="display: none;">
                                        <div class="col-12">
                                            <div class="form-check">
                                                <input class="form-check-input split-invoice-check" type="checkbox" id="splitInvoice-1" data-expense-id="1">
                                                <label class="form-check-label" for="splitInvoice-1">
                                                    This is a split from the same invoice as above
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Amount Section -->
                            <div class="total-section mt-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="total-amount">Total Amount: ₹<span id="totalAmount">0.00</span></div>
                                        <div class="amount-words mt-2">Amount in words: <span id="amountInWords">Zero rupees only</span></div>
                                        <input type="hidden" name="total_amount" id="totalAmountInput" value="0">
                                        <input type="hidden" name="amount_in_words" id="amountInWordsInput" value="Zero rupees only">
                                    </div>
                                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                                        <button type="button" class="btn btn-primary" id="submitBtn">
                                            <i class="fas fa-paper-plane me-2"></i> Submit Expense
                                        </button>
                                        <button type="reset" class="btn btn-secondary ms-2">
                                            <i class="fas fa-redo me-2"></i> Reset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approvalModalLabel">Send for Approval</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="approvalForm">
                        <div class="mb-3">
                            <label for="approverType" class="form-label">Send to:</label>
                            <select class="form-select" id="approverType">
                                <option value="manager" selected>Manager</option>
                                <option value="custom">Custom Email Addresses</option>
                            </select>
                        </div>

                        <div class="mb-3" id="managerEmailGroup">
                            <label for="managerEmail" class="form-label">Manager's Email:</label>
                            <input type="email" class="form-control" id="managerEmail" readonly>
                        </div>

                        <div class="mb-3" id="customEmailsGroup" style="display: none;">
                            <label class="form-label">Enter email addresses:</label>
                            <div class="input-group mb-2">
                                <input type="email" class="form-control" id="newEmail" placeholder="Enter email address">
                                <button class="btn btn-outline-primary" type="button" id="addEmailBtn">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div id="emailChips" class="d-flex flex-wrap gap-2 mt-2">
                                <!-- Email chips will be added here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendApprovalBtn">Send for Approval</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all dropdowns
        var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
        var dropdownList = dropdownElementList.map(function(dropdownToggleEl) {
            return new bootstrap.Dropdown(dropdownToggleEl);
        });

        // Initialize datepicker for from date
        $('#fromDate').datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true,
            yearRange: "2020:2030",
            maxDate: 0, // Can't select future dates
            beforeShow: function(input, inst) {
                // Ensure the datepicker appears above other elements
                inst.dpDiv.css({
                    zIndex: 1051
                });
            },
            onSelect: function(dateText) {
                // When from date changes, update the minimum date for to date
                $('#toDate').datepicker('option', 'minDate', dateText);

                // Enable the to date field once from date is selected
                $('#toDate').prop('disabled', false);
            }
        });

        // Initialize datepicker for to date
        $('#toDate').datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true,
            yearRange: "2020:2030",
            maxDate: 0, // Can't select future dates
            beforeShow: function(input, inst) {
                // Ensure the datepicker appears above other elements
                inst.dpDiv.css({
                    zIndex: 1051
                });
            }
        }).prop('disabled', true); // Initially disabled until from date is selected

        // Initialize datepicker for invoice dates
        $('.expense-item .datepicker').datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true,
            yearRange: "2020:2030",
            maxDate: 0, // Can't select future dates
            beforeShow: function(input, inst) {
                // Ensure the datepicker appears above other elements
                inst.dpDiv.css({
                    zIndex: 1051
                });
            }
        });

        // Employee name autocomplete
        $("#employeeName").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "/api/employees",
                    dataType: "json",
                    data: {
                        term: request.term
                    },
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 2,
            select: function(event, ui) {
                // Fill in employee details
                $("#employeeId").val(ui.item.employee_id);
                $("#employeeIdDisplay").val(ui.item.employee_id);
                $("#employeeEmail").val(ui.item.email);
                $("#employeeManager").val(ui.item.manager);
                $("#managerEmail").val(ui.item.manager);
                return true;
            }
        });

        // Add expense button
        let expenseCount = 1;
        $("#addExpenseBtn").click(function() {
            expenseCount++;

            // Clone the first expense item
            const newExpense = $("#expense-1").clone();

            // Update IDs and attributes
            newExpense.attr("id", `expense-${expenseCount}`);

            // Update all input IDs and names
            newExpense.find("input, select, textarea").each(function() {
                const oldId = $(this).attr("id");
                if (oldId) {
                    const newId = oldId.replace("-1", `-${expenseCount}`);
                    $(this).attr("id", newId);
                }

                // Clear values
                if (!$(this).hasClass("split-invoice-check")) {
                    $(this).val("");
                }
            });

            // Initialize datepicker for the new expense item
            newExpense.find(".datepicker").datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                yearRange: "2020:2030",
                maxDate: 0
            });

            // Update labels
            newExpense.find("label").each(function() {
                const oldFor = $(this).attr("for");
                if (oldFor) {
                    const newFor = oldFor.replace("-1", `-${expenseCount}`);
                    $(this).attr("for", newFor);
                }
            });

            // Update remove button
            newExpense.find(".remove-expense").attr("data-expense-id", expenseCount);

            // Update split invoice checkbox
            newExpense.find(".split-invoice-check").attr("data-expense-id", expenseCount);
            newExpense.find(".split-invoice-check").attr("id", `splitInvoice-${expenseCount}`);
            newExpense.find(".split-invoice-row").show();

            // Append the new expense item
            $("#expenseItems").append(newExpense);

            // Initialize datepicker for the new expense
            $(`#invoiceDate-${expenseCount}`).datepicker({
                dateFormat: 'dd-mm-yy',
                changeMonth: true,
                changeYear: true,
                yearRange: "2020:2030",
                maxDate: 0
            });

            // Add event listener for the new remove button
            $(`#expense-${expenseCount} .remove-expense`).click(function() {
                const expenseId = $(this).data("expense-id");
                $(`#expense-${expenseId}`).remove();
                updateTotalAmount();
            });

            // Add event listener for the new split invoice checkbox
            $(`#splitInvoice-${expenseCount}`).change(function() {
                const expenseId = $(this).data("expense-id");
                const isChecked = $(this).prop("checked");

                if (isChecked) {
                    // Disable receipt upload for split invoices
                    $(`#receipt-${expenseId}`).prop("disabled", true).prop("required", false);
                } else {
                    // Enable receipt upload for non-split invoices
                    $(`#receipt-${expenseId}`).prop("disabled", false).prop("required", true);
                }
            });

            // Add event listener for the new amount input
            $(`#amount-${expenseCount}`).on("input", updateTotalAmount);
        });

        // Remove expense button
        $(document).on("click", ".remove-expense", function() {
            const expenseId = $(this).data("expense-id");
            if (expenseId !== 1) { // Don't remove the first expense item
                $(`#expense-${expenseId}`).remove();
                updateTotalAmount();
            }
        });

        // Split invoice checkbox
        $(document).on("change", ".split-invoice-check", function() {
            const expenseId = $(this).data("expense-id");
            const isChecked = $(this).prop("checked");

            if (isChecked) {
                // Disable receipt upload for split invoices
                $(`#receipt-${expenseId}`).prop("disabled", true).prop("required", false);
            } else {
                // Enable receipt upload for non-split invoices
                $(`#receipt-${expenseId}`).prop("disabled", false).prop("required", true);
            }
        });

        // Update total amount when amount inputs change
        $(document).on("input", ".amount-input", updateTotalAmount);

        function updateTotalAmount() {
            let total = 0;
            $(".amount-input").each(function() {
                const amount = parseFloat($(this).val()) || 0;
                total += amount;
            });

            $("#totalAmount").text(total.toFixed(2));
            $("#totalAmountInput").val(total.toFixed(2));

            // Update amount in words
            const amountInWords = numberToWords(total);
            $("#amountInWords").text(amountInWords);
            $("#amountInWordsInput").val(amountInWords);
        }

        // Convert number to words
        function numberToWords(num) {
            const units = ["", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
            const tens = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];

            if (num === 0) return "Zero rupees only";

            // Handle decimal part
            const decimalPart = Math.round((num % 1) * 100);
            const wholePart = Math.floor(num);

            let result = "";

            if (wholePart > 0) {
                // Convert whole part to words
                if (wholePart >= 10000000) {
                    result += convertLessThanThousand(Math.floor(wholePart / 10000000)) + " crore ";
                    num %= 10000000;
                }

                if (wholePart >= 100000) {
                    result += convertLessThanThousand(Math.floor(wholePart / 100000)) + " lakh ";
                    num %= 100000;
                }

                if (wholePart >= 1000) {
                    result += convertLessThanThousand(Math.floor(wholePart / 1000)) + " thousand ";
                    num %= 1000;
                }

                result += convertLessThanThousand(wholePart % 1000);

                result += " rupees";
            }

            // Add decimal part if exists
            if (decimalPart > 0) {
                result += " and " + convertLessThanThousand(decimalPart) + " paise";
            }

            return result + " only";

            function convertLessThanThousand(num) {
                if (num === 0) return "";

                let result = "";

                if (num >= 100) {
                    result += units[Math.floor(num / 100)] + " hundred ";
                    num %= 100;

                    if (num > 0) {
                        result += "and ";
                    }
                }

                if (num > 0) {
                    if (num < 20) {
                        result += units[num];
                    } else {
                        result += tens[Math.floor(num / 10)];
                        if (num % 10 > 0) {
                            result += "-" + units[num % 10];
                        }
                    }
                }

                return result;
            }
        }

        // Submit button
        $("#submitBtn").click(function() {
            // Validate form
            if (!validateForm()) {
                return;
            }

            // Show approval modal
            const managerEmail = $("#employeeManager").val();
            $("#managerEmail").val(managerEmail);

            const approvalModal = new bootstrap.Modal(document.getElementById('approvalModal'));
            approvalModal.show();
        });

        // Validate form
        function validateForm() {
            // Check if all required fields are filled
            const form = document.getElementById("expenseForm");
            if (!form.checkValidity()) {
                // Trigger browser's native validation
                form.reportValidity();
                return false;
            }

            // Additional validation logic can be added here

            return true;
        }

        // Approver type selection
        $("#approverType").change(function() {
            const selectedType = $(this).val();

            if (selectedType === "manager") {
                $("#managerEmailGroup").show();
                $("#customEmailsGroup").hide();
            } else {
                $("#managerEmailGroup").hide();
                $("#customEmailsGroup").show();
            }
        });

        // Add email button
        $("#addEmailBtn").click(function() {
            const email = $("#newEmail").val().trim();

            // Validate email
            if (!email || !isValidEmail(email)) {
                alert("Please enter a valid email address");
                return;
            }

            // Check if email already exists
            if ($("#emailChips").find(`[data-email="${email}"]`).length > 0) {
                alert("This email has already been added");
                return;
            }

            // Add email chip
            const chip = $(`
                <div class="email-chip" data-email="${email}">
                    ${email}
                    <i class="fas fa-times ms-2 remove-email" style="cursor: pointer;"></i>
                </div>
            `);

            $("#emailChips").append(chip);
            $("#newEmail").val("");
        });

        // Remove email chip
        $(document).on("click", ".remove-email", function() {
            $(this).parent().remove();
        });

        // Validate email format
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Submit button
        $("#submitBtn").click(function() {
            // Validate form
            if (!validateForm()) {
                return;
            }

            // Show approval modal
            const managerEmail = $("#employeeManager").val();
            $("#managerEmail").val(managerEmail);

            const approvalModal = new bootstrap.Modal(document.getElementById('approvalModal'));
            approvalModal.show();
        });

        // Send for approval button
        $("#sendApprovalBtn").click(function() {
            const approverType = $("#approverType").val();
            let approverEmails = [];

            if (approverType === "manager") {
                const managerEmail = $("#managerEmail").val().trim();
                if (managerEmail) {
                    approverEmails.push(managerEmail);
                }
            } else {
                // Get all custom emails
                $("#emailChips").find(".email-chip").each(function() {
                    approverEmails.push($(this).data("email"));
                });
            }

            // Validate approver emails
            if (approverEmails.length === 0) {
                alert("Please specify at least one approver email");
                return;
            }

            // Show loading screen
            if (typeof LoadingScreen !== 'undefined') {
                LoadingScreen.show(5); // Show loading screen for 5 seconds
            }

            // Submit the form using AJAX to prevent page redirect
            $.ajax({
                url: $("#expenseForm").attr("action"),
                type: "POST",
                data: new FormData($("#expenseForm")[0]),
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        // Get the EPV ID from the response
                        const epvId = response.epv_id;
                        console.log("EPV ID from response:", epvId);

                        // Send approval request
                        if (approverEmails.length > 0) {
                            console.log("Sending approval request for EPV ID:", epvId);
                            console.log("Approver emails:", approverEmails);

                            $.ajax({
                                url: "/send-for-approval",
                                type: "POST",
                                contentType: "application/json",
                                data: JSON.stringify({
                                    epv_id: epvId,
                                    approval_option: approverType === "manager" ? "yes" : "no",
                                    manager_email: approverType === "manager" ? approverEmails[0] : "",
                                    custom_emails: approverType === "custom" ? approverEmails : []
                                }),
                                success: function(approvalResponse) {
                                    // Hide loading screen
                                    if (typeof LoadingScreen !== 'undefined') {
                                        LoadingScreen.hide();
                                    }

                                    // Show success message
                                    Swal.fire({
                                        title: 'Success!',
                                        text: response.message + " " + (approvalResponse.success ? approvalResponse.message : ""),
                                        icon: 'success',
                                        confirmButtonText: 'OK'
                                    }).then((result) => {
                                        // Redirect to EPV records page
                                        window.location.href = '/epv-records';
                                    });
                                },
                                error: function(xhr, status, error) {
                                    // Hide loading screen
                                    if (typeof LoadingScreen !== 'undefined') {
                                        LoadingScreen.hide();
                                    }

                                    // Show success message for expense submission but error for approval
                                    Swal.fire({
                                        title: 'Partial Success',
                                        text: response.message + " However, there was an error sending the approval request.",
                                        icon: 'warning',
                                        confirmButtonText: 'OK'
                                    }).then((result) => {
                                        // Redirect to EPV records page
                                        window.location.href = '/epv-records';
                                    });
                                }
                            });
                        } else {
                            // Hide loading screen
                            if (typeof LoadingScreen !== 'undefined') {
                                LoadingScreen.hide();
                            }

                            // Show success message
                            Swal.fire({
                                title: 'Success!',
                                text: response.message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then((result) => {
                                // Redirect to EPV records page
                                window.location.href = '/epv-records';
                            });
                        }
                    } else {
                        // Hide loading screen
                        if (typeof LoadingScreen !== 'undefined') {
                            LoadingScreen.hide();
                        }

                        // Show error message
                        Swal.fire({
                            title: 'Error!',
                            text: response.message || 'An error occurred while submitting the expense.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    // Hide loading screen
                    if (typeof LoadingScreen !== 'undefined') {
                        LoadingScreen.hide();
                    }

                    // Show error message
                    Swal.fire({
                        title: 'Error!',
                        text: 'An error occurred while submitting the expense.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });

        // Get finance settings
        $.ajax({
            url: "/api/settings/finance",
            method: "GET",
            success: function(data) {
                // Apply date validation rules
                const maxDays = data.days || 30; // Default to 30 days if not specified

                $(".datepicker").datepicker("option", "minDate", -maxDays);
            }
        });
    });
</script>
{% endblock %}
